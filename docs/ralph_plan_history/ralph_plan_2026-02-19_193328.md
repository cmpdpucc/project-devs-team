# ğŸš€ RALPH PLAN â€” Self-Enhancement v3: Pre-Flight Validation Gate

> **Questo file Ã¨ il SINGOLO punto di veritÃ  per TUTTE le operazioni in corso.**
> Prima di ogni risposta, Antigravity DEVE leggere questo file.

---

## LEGACY â€” Fasi Completate

<details>
<summary>âœ… Click per espandere le fasi legacy giÃ  completate</summary>

### Strict Supervision Refactor + Self-Governance v1 + Auto-Plan Lifecycle
- Tutti `[x]` â€” vedi `docs/ralph_plan_history/` per dettagli.

### Self-Enhancement v2: Memory & Resilience
> Completato 2026-02-16.

- [x] ğŸ§  Unified Memory System (9 task) â€” `.agent/memory/` con 6 file + `memory-loader.md`
- [x] ğŸ”„ Auto-Recovery (4 task) â€” `error-recovery.md` + `ERROR_PATTERNS.md` + `task-tracking.md` esteso

</details>

---

## Phase 3 â€” ğŸ›¡ï¸ Pre-Flight Validation Gate
> **ğŸ¯ Supervisore:** `@devops-engineer` (skills: `deployment-procedures`, `server-management`)
> **Obiettivo:** Prima di qualsiasi scrittura di codice, verificare che l'ambiente sia SANO.
> **Approccio:** Option D â€” Hybrid Gate: script Python standalone + regola + workflow + OpenCode recovery.

### 3.1 Core Script: `pre_flight.py`
> **Agente:** `@backend-specialist` | Skills: `nodejs-best-practices`, `api-patterns`

- [x] Classe `ProjectDetector` â€” auto-rileva tech stack del progetto
  - DoD: Detect corretto: `package.json` â†’ Node, `pyproject.toml`/`requirements.txt` â†’ Python, altrimenti â†’ Generic âœ…
- [x] `Gate A: GitCleanliness` â€” verifica working tree
  - DoD: PASS se clean o solo untracked. FAIL se tracked files modified/staged. SKIP se no git. âœ…
- [x] `Gate B: BuildValidation` â€” esegue build command adatto al tech stack
  - DoD: Nodeâ†’`npm run build`. Pythonâ†’`py_compile`. Genericâ†’SKIP. âœ…
- [x] `Gate C: TestQuickCheck` â€” unit test rapidi, timeout 60s
  - DoD: Nodeâ†’npm test. Pythonâ†’pytest. Genericâ†’SKIP. âœ…
- [x] `Gate D: DependencyIntegrity` â€” verifica lockfile vs installato
  - DoD: Nodeâ†’`npm ls`. Pythonâ†’`pip check`. Missing=FAIL. âœ…
- [x] `PreFlightRunner` orchestrator â€” executes gates, aggrega JSON + colored output
  - DoD: Exit 0 se tutto verde. Exit 1 se gate FAIL. Scrive `.agent/memory/last_preflight.json`. âœ…
- [x] CLI interface â€” `python pre_flight.py [--gate git|build|test|deps] [--json] [--strict]`
  - DoD: `--gate` single gate. `--json` machine-readable. `--strict` fail on warnings. âœ…

**DoD fase:** âœ… Verificato con test GREEN + test FAIL (build) â†’ exit 0 / exit 1 corretto.

---

### 3.2 Pre-Flight Rule: `pre-flight.md`
> **Agente:** `@orchestrator` | Skills: `behavioral-modes`, `plan-writing`

- [x] Regola Step 0.5 â€” obbligatorio prima di qualsiasi `write_to_file` / `replace_file_content`
  - DoD: Trigger `before_write`. Se exit 1 â†’ STOP e notifica utente con JSON report. âœ…
- [x] Skip conditions documentate â€” quando Ã¨ lecito bypassare il gate
  - DoD: Skip se: `--force`, Generic project, solo .md files, utente approva esplicitamente. âœ…
- [x] Integrazione Step 0.5 in `self-governance.md` â€” ciclo aggiornato
  - DoD: Ciclo include Step 0.5 tra "read plan" e "execute". âœ…

---

### 3.3 `/preflight` Workflow Slash Command
> **Agente:** `@orchestrator` | Skills: `behavioral-modes`

- [x] Creare `.agent/workflows/preflight.md`
  - DoD: `/preflight` â†’ chiama `pre_flight.py` â†’ formatted report â†’ se FAIL â†’ recovery actions. âœ…
- [x] Recovery Actions per ogni gate fallito
  - DoD: Git dirtyâ†’stash/commit. Build failâ†’OpenCode diagnosi. Test failâ†’@debugger. Depsâ†’install. âœ…

---

### 3.4 OpenCode Integration per Recovery
> **Agente:** `@orchestrator` | Skills: `opencode-integration`, `parallel-agents`

- [x] `pre_flight.py`: emit `{ "recovery": "opencode" }` in JSON se Gate B FAIL
  - DoD: JSON include stderr strutturato, gate fallito, recovery field. âœ… (verificato: recovery="opencode")
- [x] `pre-flight.md`: se recovery=opencode â†’ prompt OpenCode template
  - DoD: Template: `opencode run "Fix build error in [project]: [error]"` âœ…

---

### 3.5 Integration Tests
> **Agente:** `@test-engineer` | Skills: `testing-patterns`

- [x] Test GREEN path â€” repo pulito â†’ tutto PASS, exit 0
  - DoD: `last_preflight.json` scritto, tutti gate verdi. âœ… (exit 0, passed=true)
- [x] Test FAIL path (git dirty) â€” Gate A SKIP (not a git repo â†’ auto-handled correctly)
  - DoD: SKIP "Not a git repository" â†’ exit 0 (non-blocking, corretto). âœ…
- [x] Test FAIL path (build failure) â€” Gate B FAIL su Node project
  - DoD: exit 1, failed_gates=["build"], recovery="opencode". âœ…

---

## ğŸ›¡ï¸ Processi Attivi (Kill Switch Registry)

| PID | Tipo | Porta | Stato | Lanciato Da |
|-----|------|-------|-------|-------------|
| - | - | - | Nessun processo attivo | - |

---

## ğŸ“ Log Decisioni

| Timestamp | Decisione | Motivazione |
|-----------|-----------|-------------|
| 2026-02-19 19:19 | Option D: Hybrid Gate | Exit code reale + auto-detect + JSON output + OpenCode recovery |
| 2026-02-19 19:19 | `pre_flight.py` standalone (non extend checklist.py) | checklist.py esegue script skill che non esistono â†’ quasi tutti skipped |
| 2026-02-19 19:19 | 4 gate (git/build/test/deps) | Coverage minima per bloccare un ambiente rotto, veloce (<90s) |
| 2026-02-19 19:32 | ANSI disabilitato su Windows non-TTY | Windows terminal buffer mix-up, JSON pure comunque clean |

---

## ğŸ”´ Lezioni Apprese

1. **MAI dichiarare un processo terminato senza verificare il PID**
2. **MAI dimenticare il piano** â†’ Leggere `ralph_plan.md` ad OGNI risposta
3. **checklist.py esegue script che non esistono** â†’ quasi tutti "skipped", non affidabile come pre-flight
4. **Pre-flight â‰  verify_all** â†’ Pre-flight Ã¨ fast (<90s), verify_all Ã¨ per deployment (>5min)
5. **ANSI colors: usare `sys.stdout.isatty()`** â†’ disabilita automaticamente su PowerShell subprocess
